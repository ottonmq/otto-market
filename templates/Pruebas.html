




.from django.db import models
from django.contrib.auth.models import User

# 1. PERFIL: Datos del operador centralizados
class Perfil(models.Model):
    PREFIJOS = [
        ('503', 'SV +503'),
        ('502', 'GT +502'),
        ('504', 'HN +504'),
        ('505', 'NI +505'),
        ('506', 'CR +506'),
        ('1', 'USA +1'),
    ]

    usuario = models.OneToOneField(User, on_delete=models.CASCADE, related_name='perfil')
    nombre = models.CharField(max_length=100, blank=True, null=True)
    foto_perfil = models.ImageField(upload_to='perfiles/', blank=True, null=True)
    
    # Sistema de contacto único
    prefijo = models.CharField(max_length=5, choices=PREFIJOS, default='503')
    telefono = models.CharField(max_length=15, blank=True, null=True)
    correo = models.EmailField(max_length=254, blank=True, null=True)
    direccion = models.CharField(max_length=250, blank=True, null=True)

    fecha_unido = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"Operador: {self.usuario.username}"

# 2. CATEGORÍAS (Vehículos, Propiedades, etc.)
class Categoria(models.Model):
    nombre = models.CharField(max_length=100)

    def __str__(self): 
        return self.nombre

# 3. PUBLICACIÓN: El núcleo del sistema
class Publicacion(models.Model):
    TIPO_NEGOCIO = [
        ('VENTA', 'Venta'),
        ('ALQUILER', 'Alquiler'),
        ('CAMBIO', 'Cambio / Permuta'),
        ('SERVICIO','Servicio')
    ]
    ESTADO_ITEM = [
        ('NUEVO', 'Nuevo'),
        ('USADO', 'Usado'),
    ]

    vendedor = models.ForeignKey(User, on_delete=models.CASCADE, related_name='mis_publicaciones')
    categoria = models.ForeignKey(Categoria, on_delete=models.CASCADE)

    # Datos técnicos del anuncio
    titulo = models.CharField(max_length=255, blank=True, null=True)
    marca = models.CharField(max_length=100, blank=True, null=True)
    modelo = models.CharField(max_length=100, blank=True, null=True)
    precio = models.DecimalField(max_digits=15, decimal_places=2, blank=True, null=True)
    descripcion = models.TextField(blank=True, null=True)
    
    # Mantenemos este campo para no romper la DB, pero la lógica usará el del Perfil
    telefono = models.CharField(max_length=20, blank=True, null=True) 
    
    foto = models.ImageField(upload_to='productos/', blank=True, null=True)
    tipo_negocio = models.CharField(max_length=10, choices=TIPO_NEGOCIO, blank=True, null=True)
    estado_fisico = models.CharField(max_length=10, choices=ESTADO_ITEM, blank=True, null=True)
    
    vendido = models.BooleanField(default=False)
    fecha_creacion = models.DateTimeField(auto_now_add=True)
    vistas = models.PositiveIntegerField(default=0)
    
    def __str__(self):
        estado = 'VENDIDO' if self.vendido else 'ACTIVO'
        return f"{self.titulo} - {estado}"

      
    def get_absolute_url(self):
        from django.urls import reverse
        # El sitemap usará este enlace para decirle a Google dónde está cada anuncio
        return reverse('detalle', args=[str(self.id)])



# 4. GALERÍA ADICIONAL
# 4. GALERÍA ADICIONAL
class Imagen(models.Model):
    publicacion = models.ForeignKey(Publicacion, on_delete=models.CASCADE, related_name='fotos')
    # Cambiamos 'archivo' por 'imagen' para que coincida con el Admin
    # Agregamos null/blank para que no bloquee el guardado
    imagen = models.ImageField(upload_to='productos/', null=True, blank=True)

    def __str__(self):
        return f"Imagen de {self.publicacion.titulo}"
